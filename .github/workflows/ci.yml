name: CI - Pruebas y Calidad de CÃ³digo

on:
  pull_request:
    branches:
      - main
      - master

jobs:
  test-and-lint:
    name: Pruebas Unitarias y Linting
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Instalar pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: ğŸŸ¢ Configurar Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: ğŸ“¦ Instalar dependencias
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Ejecutar validaciÃ³n completa (ESLint + TypeScript + Tests)
        run: pnpm run validate
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://test.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'test-key' }}
        continue-on-error: false

      - name: ğŸ“Š Generar reporte de cobertura
        run: pnpm run test:coverage
        continue-on-error: true

      - name: ğŸ“¤ Subir reporte de cobertura
        uses: codecov/codecov-action@v3
        if: matrix.node-version == '20.x'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ğŸ—ï¸ Verificar build
        run: pnpm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://test.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'test-key' }}

  type-check:
    name: VerificaciÃ³n de Tipos (TypeScript)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Instalar pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: ğŸ“¦ Instalar dependencias
        run: pnpm install --frozen-lockfile

      - name: ğŸ”· Verificar tipos TypeScript
        run: pnpm exec tsc --noEmit

  security-check:
    name: VerificaciÃ³n de Seguridad
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Instalar pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: ğŸ“¦ Instalar dependencias
        run: pnpm install --frozen-lockfile

      - name: ğŸ”’ AuditorÃ­a de seguridad
        run: pnpm audit --audit-level=high
        continue-on-error: true

  code-quality:
    name: AnÃ¡lisis de Calidad de CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

  status-check:
    name: âœ… Estado Final del Pipeline
    runs-on: ubuntu-latest
    needs: [test-and-lint, type-check, security-check]
    if: always()

    steps:
      - name: ğŸ“Š Verificar resultados
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RESUMEN DE VALIDACIONES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Test y Lint: ${{ needs.test-and-lint.result }}"
          echo "Type Check: ${{ needs.type-check.result }}"
          echo "Security Check: ${{ needs.security-check.result }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "${{ needs.test-and-lint.result }}" != "success" ]; then
            echo "âŒ FALLO: Las pruebas unitarias o el linting fallaron"
            echo "â„¹ï¸  Revisa los logs de 'Test y Lint' para mÃ¡s detalles"
            exit 1
          fi
          
          if [ "${{ needs.type-check.result }}" != "success" ]; then
            echo "âŒ FALLO: La verificaciÃ³n de tipos TypeScript fallÃ³"
            echo "â„¹ï¸  Revisa los logs de 'Type Check' para mÃ¡s detalles"
            exit 1
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Ã‰XITO: Todas las validaciones pasaron"
          echo "âœ“ ESLint: Sin errores ni warnings"
          echo "âœ“ TypeScript: Sin errores de tipos"
          echo "âœ“ Tests: Todos pasando"
          echo "âœ“ Build: CompilaciÃ³n exitosa"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ El PR estÃ¡ listo para merge"

