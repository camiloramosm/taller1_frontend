name: CI - Pruebas y Calidad de CÃ³digo

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master

jobs:
  test-and-lint:
    name: Pruebas Unitarias y Linting
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Configurar Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependencias
        run: npm ci

      - name: ğŸ” Ejecutar ESLint
        run: npm run lint
        continue-on-error: false

      - name: ğŸ§ª Ejecutar pruebas unitarias
        run: npm run test
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://test.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'test-key' }}

      - name: ğŸ“Š Generar reporte de cobertura
        run: npm run test:coverage
        continue-on-error: true

      - name: ğŸ“¤ Subir reporte de cobertura
        uses: codecov/codecov-action@v3
        if: matrix.node-version == '20.x'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ğŸ—ï¸ Verificar build
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://test.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'test-key' }}

  # type-check:
  #   name: VerificaciÃ³n de Tipos (TypeScript)
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: ğŸ“¥ Checkout del cÃ³digo
  #       uses: actions/checkout@v4

  #     - name: ğŸŸ¢ Configurar Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20.x'
  #         cache: 'npm'

  #     - name: ğŸ“¦ Instalar dependencias
  #       run: npm ci

  #     - name: ğŸ”· Verificar tipos TypeScript
  #       run: npx tsc --noEmit

  security-check:
    name: VerificaciÃ³n de Seguridad
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependencias
        run: npm ci

      - name: ğŸ”’ AuditorÃ­a de seguridad
        run: npm audit --audit-level=high
        continue-on-error: true

  code-quality:
    name: AnÃ¡lisis de Calidad de CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

  status-check:
    name: âœ… Estado Final del Pipeline
    runs-on: ubuntu-latest
    needs: [test-and-lint, security-check]
    if: always()

    steps:
      - name: ğŸ“Š Verificar resultados
        run: |
          echo "Test y Lint: ${{ needs.test-and-lint.result }}"
          echo "Security Check: ${{ needs.security-check.result }}"
          
          if [ "${{ needs.test-and-lint.result }}" != "success" ]; then
            echo "âŒ Las pruebas unitarias o el linting fallaron"
            exit 1
          fi
          
          echo "âœ… Todos los checks pasaron correctamente"

